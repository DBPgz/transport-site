<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Temps réel</title>
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.13.1/build/styles/default.min.css">
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.13.1/build/highlight.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
        integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
        integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
        crossorigin=""></script>
    <script defer src="https://use.fontawesome.com/releases/v5.6.3/js/all.js"
        integrity="sha384-EIHISlAOj4zgYieurP0SdoiBYfGJKkgWedPHH4jCzpCXLmzVsw1ouK59MuUtP4a1"
        crossorigin="anonymous"></script>
    <style>
        #json {
            width: 30%;
            float: left;
            margin: 0.5em;
        }

        #map {
            float: left;
            height: 600px;
            width: 50%;
        }

        .bus {
            text-align: center;
            font-size: 2em;
        }

        .aimed {
            text-decoration: line-through;
        }

        #horaires {
            font-size: 2em;
        }

        #horaires>ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<body>
    <pre>
        <code class="json hljs" id="json"></code>
    </pre>
    <div id="map"></div>
    <script>
        var mymap
        var markersLayer
        var data

        async function fetchStops(dataset_url, bounds) {
            const params = `BoundingBoxStructure.UpperLeft.Longitude=${bounds.getNorthWest().lng}\
&BoundingBoxStructure.UpperLeft.Latitude=${bounds.getNorthWest().lat}\
&BoundingBoxStructure.LowerRight.Longitude=${bounds.getSouthEast().lng}\
&BoundingBoxStructure.LowerRight.Latitude=${bounds.getSouthEast().lat}`

            const url = `${dataset_url}siri/2.0/stoppoints-discovery.json?${params}`
            const response = await fetch(url)
            const json = await response.json()
            return json.Siri.StopPointsDelivery.AnnotatedStopPoint.slice(0, 20);
        }

        function fetchAllStops(datasets, bounds) {
            const dataset_urls = datasets.map(d => d._links.self.href)
            return dataset_urls.map(url => [fetchStops(url, bounds), url])
        }

        async function fetchNextDepartures(stop, dataset_url) {
            const url = `${dataset_url}siri/2.0/stop-monitoring.json?MonitoringRef=${stop.StopPointRef}`
            const response = await fetch(url)
            const json = await response.json()

            const checkVisit = visit => visit.MonitoredVehicleJourney.MonitoredCall.ExpectedDepartureTime != undefined;
            return json.Siri.ServiceDelivery.StopMonitoringDelivery.flatMap(sp_visit =>
                sp_visit.MonitoredStopVisit.filter(checkVisit).map(visit => visit.MonitoredVehicleJourney))
        }

        async function makeMarkers(stop, url) {
            const next_departures = await fetchNextDepartures(stop, url)
            return makeMarker(stop, next_departures)
        }

        async function loader(e) {
            let cleared = false;
            let stops_by_dataset = fetchAllStops(data, mymap.getBounds());
            let next_departures = await Promise.all(stops_by_dataset.map(([stops_promise, url]) =>
                stops_promise.then(stops => stops.map(stop => makeMarkers(stop, url)))))
            next_departures.flat().forEach(m_promise => m_promise.then(marker => {
                if(marker !== null) {
                    if(!cleared) {
                        markersLayer.clearLayers()
                        cleared = true
                    }
                    marker.addTo(markersLayer)
                }
            }))
        }

        function makeMarker(sp, monitoredVehicleJourneys) {
            const l = monitoredVehicleJourneys.map(mvj => {
                    const call = mvj.MonitoredCall
                    const aimed_time = call.AimedDepartureTime.split("T")[1]
                    const expected_time = call.ExpectedDepartureTime.split("T")[1]
                    return `<li>${mvj.LineRef}: <span class="aimed">${aimed_time}</span> <span class="expected">${expected_time}</span></li>`
                }).join("\n")
            if (l === "") {
                return null;
            }

            return L.marker([sp.Location.latitude, sp.Location.longitude], {
                popupAnchor: [155, 370],
                title: sp.StopPointRef
            }).bindPopup(
                `<p class="bus"><i class="fas fa-bus"></i></p> <div id="horaires"><ul>${l}</ul></div>`
            )
        }

        async function datasets() {
            const data = await fetch("https://tr.transport.data.gouv.fr")
            const json = await data.json()
            return json.datasets
        }

        async function init() {
            data = await datasets()

            mymap = L.map('map').setView([47,2], 6)
            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                maxZoom: 18,
                id: 'mapbox.streets',
                accessToken: 'pk.eyJ1IjoibC12aW5jZW50LWwiLCJhIjoiaDJfM05UMCJ9.l9oR075SSzJY9hXEqaRvoQ'
            }).addTo(mymap)

            markersLayer = L.layerGroup()

            markersLayer.addTo(mymap)

            mymap.on('moveend', loader)
            mymap.on('zoomend', loader)
            loader()
        }

        window.onload = init;
    </script>
</body>

</html>
