<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Temps réel</title>
        <link rel="stylesheet"
              href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.13.1/build/styles/default.min.css">
        <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.13.1/build/highlight.min.js"></script>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
                               integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
                               crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
                integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
                crossorigin=""></script>
        <script defer src="https://use.fontawesome.com/releases/v5.6.3/js/all.js" integrity="sha384-EIHISlAOj4zgYieurP0SdoiBYfGJKkgWedPHH4jCzpCXLmzVsw1ouK59MuUtP4a1" crossorigin="anonymous"></script>
        <style>
#json {
    width: 30%;
    float: left;
    margin: 0.5em;
}
#map {
    float: left;
    height: 600px;
    width: 50%;
}
.mapLabel {
    background: white;
    border: 1px solid #888;
    border-radius: 30px;

    position: relative;

    display: inline-block;
    white-space: nowrap;
    font-size: 20px;
}

.bus { text-align: center; }


.aimed {
    text-decoration: line-through;
}

        </style>
    </head>
    <body>
        <div id="debug"></div>
        <pre>
        <code class="json hljs" id="json"></code>
        </pre>
        <div id="map"></div>
        <script>
var loadDiscovery = async function(map, collisionLayer, service_url) {
        var bounds = map.getBounds();
        params=`BoundingBoxStructure.UpperLeft.Longitude=${bounds.getNorthWest().lng}`
        params = `${params}&BoundingBoxStructure.UpperLeft.Latitude=${bounds.getNorthWest().lat}`
        params = `${params}&BoundingBoxStructure.LowerRight.Longitude=${bounds.getSouthEast().lng}`
        params = `${params}&BoundingBoxStructure.LowerRight.Latitude=${bounds.getSouthEast().lat}`
        var url = `${service_url}/stoppoints_discovery.json?${params}`
        var response = await fetch(url, {params: params});
        var json = await response.json();
        for(var i=0; i<json.Siri.StopPointsDelivery.AnnotatedStopPoint.length; i++) {
            var sp = json.Siri.StopPointsDelivery.AnnotatedStopPoint[i];
            var rt = await loadRT(service_url, map, sp, collisionLayer)
            if (rt) {
                break;
            }
        }
}

var checkVisit = visit => {
    return visit.MonitoringVehicleJourney.MonitoredCall.ExpectedDepartureTime != undefined;
}

const loadRT = async function(service_url, map, sp, collisionLayer) {
    var url = `${service_url}/stop_monitoring.json?MonitoringRef=${sp.StopPointRef}`

    var response = await fetch(url);
    if (!response.ok) return false;
    var json = await response.json();
    var v = "<ul>"
    var l = json.Siri.ServiceDelivery.StopMonitoringDelivery.map(function(sp_visit) {
        return sp_visit.MonitoredStopVisits.filter(checkVisit).map(visit => {
            var mvj = visit.MonitoringVehicleJourney
            var call = mvj.MonitoredCall
            return `<li>${mvj.LineRef}: <span class="aimed">${call.AimedDepartureTime.split("T")[1]}</span> <span class="expected">${call.ExpectedDepartureTime.split("T")[1]}</span></li>`
        }).join("\n")
    }).join("\n")

    if (l === "") {
        return false;
    }
    document.getElementById("json").innerHTML = JSON.stringify(json, null, '  ');

    v = `${v}${l}</ul>`
    var marker = L.marker([sp.Location.latitude, sp.Location.longitude], {
        icon: L.divIcon({
            className: 'mapLabel',
            iconSize: [300, 150],
            iconAnchor: [150, 220],
            html: `<p class="bus"><i class="fas fa-bus"></i></p> ${v}<p>&nbsp;</p>`,

        })
        ,interactive: false	// Post-0.7.3
        ,clickable:   false	//      0.7.3
    });
    collisionLayer.addLayer(marker);
    var m = L.marker([sp.Location.latitude, sp.Location.longitude])
    collisionLayer.addLayer(m);
    return true;
}

var load = function() {
    var mymap = L.map('map').setView([45.19508, 5.7112]  , 17);
    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        id: 'mapbox.streets',
        accessToken: 'pk.eyJ1IjoibC12aW5jZW50LWwiLCJhIjoiaDJfM05UMCJ9.l9oR075SSzJY9hXEqaRvoQ'
    }).addTo(mymap)
    var collisionLayer = L.layerGroup();
    collisionLayer.addTo(mymap)

    var removeMarkers = function() {
        collisionLayer.eachLayer(function(marker) {
            collisionLayer.removeLayer(marker)
        })
    }

    window.timeOuts = []

    var loader = function(e) {
        window.timeOuts.forEach(window.clearTimeout)
        removeMarkers()
        loadDiscovery(mymap, collisionLayer, "https://app-be8e53a7-9b77-4f95-bea0-681b97077017.cleverapps.io")
        window.timeOuts.push(setTimeout(loader, 30000))
    }
    loader(null)
    mymap.on('moveend', loader)
    mymap.on('zoomend', loader)
}
window.onload = load;
        </script>
    </body>
</html>

